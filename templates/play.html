{% extends "base_auth.html" %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='style/play.css') }}">
{% endblock %}

{% block main %}
    <video src="/stream/{{ media.path }}" id="player" autoplay></video>
    <div id="controls">
        <a href="#" id="control-play">Play</a>
        <a href="#" id="control-pause">Pause</a>
        <a href="{{ url_for('homepage') }}">Stop</a>
        <div id="progress">
            <div id="progress-inner" style="width: 0;"></div>
        </div>
        <span id="timer">0:00 / 0:00</span>
    </div>
    <script>
        function moved() {
            body.className = '';
        }

        var body = document.getElementsByTagName('body')[0];
        var video = document.getElementById('player');

        var movementTimer = setTimeout(moved, 5000);

        body.className = 'moved';
        body.addEventListener('mousemove', function () {
            body.className = 'moved';
            clearTimeout(movementTimer);
            movementTimer = setTimeout(moved, 5000);
        });

        function updateProgress() {
            if (!video.paused) {
                var progress = Math.floor(video.currentTime);

                var xhr = new XMLHttpRequest();
                xhr.open('GET', '/progress/{{ media.id }}/' + progress);
                xhr.send(null);
            }
        }

        var progressTimer = setInterval(updateProgress, 2000);

        var progressBar = document.getElementById('progress-inner');
        video.addEventListener('timeupdate', function () {
            var progress = (video.currentTime / video.duration) * 100;
            progressBar.style.width = progress + '%';
        });

        progressBar.addEventListener('click', function (event) {
            var clickedPixels = event.pageX - this.clientLeft;
            var totalPixels = this.clientWidth;
            var toProgress = (clickedPixels / totalPixels) * 100;
            video.currentTime = video.duration * toProgress;
        });

        var playButton = document.getElementById('control-play');
        var pauseButton = document.getElementById('control-pause');

        playButton.addEventListener('click', function (event) {
            event.preventDefault();
            this.style.display = 'none';
            video.play();
            pauseButton.style.display = 'inline-block';
        });

        pauseButton.addEventListener('click', function (event) {
            event.preventDefault();
            this.style.display = 'none';
            video.pause();
            playButton.style.display = 'inline-block';
        });

        {% if watchinfo.progress and watchinfo.progress > 0 %}
            var resumed = false;
            video.addEventListener('play', function () {
                if (!resumed) {
                    resumed = true;
                    video.currentTime = {{ watchinfo.progress }};
                }
            });
        {% endif %}
    </script>
{% endblock %}